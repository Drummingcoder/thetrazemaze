<!DOCTYPE html>
<html>
<head>
  <title>The Traze Maze</title>
  <link rel="icon" type="icon/x-image" href="logo.jpg">
  <link rel="stylesheet" type="text/css" href="mazestyle.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <!-- Black loading screen overlay -->
  <div id="loading-overlay"></div>
  <!-- COMMENTED OUT - Two large waving stickmen on either side of the maze -->
  <!-- <div class="waving-stickman stickman-left"></div> -->
  <!-- <div class="waving-stickman stickman-right"></div> -->
  
  <!-- Start Screen -->
  <div id="start-screen">
    <!-- Settings gear icon in top right -->
    <div id="settings-gear" title="Settings">⚙️</div>
    
    <!-- About button in bottom right -->
    <div id="about-corner" title="About">About</div>
    
    <div class="start-content">
      <h1>The Traze Maze</h1>
      <div class="start-buttons">
        <button id="start-game-btn">Start Game</button>
        <button id="upgrades-btn">Upgrades</button>
      </div>
    </div>
  </div>

  <!-- Level Select Screen -->
  <div id="level-select-screen">
    <div class="level-select-content">
      <h1>Select Level</h1>
      
      <div class="level-grid">
        <div class="level-card" id="level-1-card" data-level="1">
          <div class="level-number">Level 1</div>
          <div class="level-name">The Beginning</div>
          <div class="level-best-time" id="level-1-best-time">--:--</div>
        </div>
        
        <div class="level-card" id="level-2-card" data-level="2">
          <div class="level-number">Level 2</div>
          <div class="level-name">Back and Forth</div>
          <div class="level-best-time" id="level-2-best-time">--:--</div>
        </div>
        
        <div class="level-card locked" id="level-3-card" data-level="3">
          <div class="level-number">Level 3</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-4-card" data-level="4">
          <div class="level-number">Level 4</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-5-card" data-level="5">
          <div class="level-number">Level 5</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-6-card" data-level="6">
          <div class="level-number">Level 6</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-7-card" data-level="7">
          <div class="level-number">Level 7</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-8-card" data-level="8">
          <div class="level-number">Level 8</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-9-card" data-level="9">
          <div class="level-number">Level 9</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
        
        <div class="level-card locked" id="level-10-card" data-level="10">
          <div class="level-number">Level 10</div>
          <div class="level-name"></div>
          <div class="level-difficulty">Coming Soon</div>
        </div>
      </div>
      
      <button class="back-to-menu" id="back-to-menu-btn">← Back to Menu</button>
    </div>
  </div>

  <div id="timer">00:00.000</div>
  <div id="dash-indicator">Dash Ready</div>
  <div id="ground-pound-indicator">Ground Pound Ready</div>
  <div id="controls-hint">Arrow Keys/WASD: Move | Shift/Space: Dash | Hold Up/W: Charge Jump | Down/S (in air): Ground Pound</div>
  <!--<div id="debug-console"></div>-->
  <div id="maze-container">
    <canvas id="maze-canvas"></canvas>
    <canvas id="player-canvas"></canvas>
  </div>

  <div id="end-screen" class="hidden">
  <button id="back-button">Back</button>
  <h2 id="end-content">Congratulations!</h2>

  <div id="end-time-taken"></div>
  <div id="personal-best">
    Personal Best: <span id="best-time"></span>
  </div>
  <div id="new-personal-best" style = "display:block;">Personal New Best!</div>

    <button id="restart-button">Restart Maze</button>
  </div>

  <!--<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>-->
  
  <!-- Modular JavaScript Files - Load in dependency order -->
  <script src="./js/debug-console.js"></script>
  <script src="./js/audio-manager.js"></script>
  <script src="./js/game-timer.js"></script>
  <script src="./js/personal-best-manager.js"></script>
  <script src="./js/maze-data.js"></script>
  <script src="./js/maze-renderer.js"></script>
  <script src="./js/camera-system.js"></script>
  <script src="./js/player-animation.js"></script>
  <script src="./js/canvas-renderer.js"></script>
  <script src="./js/player-controller.js"></script>
  <script src="./js/event-handler.js"></script>
  <script src="./js/game-initializer.js"></script>
  <script src="./js/game-actions.js"></script>
  <script src="./js/start-screen-manager.js"></script>
  <script src="./js/start-level.js"></script>

  <script>
    // =================================================================
    // GLOBAL VARIABLES DECLARATION
    // =================================================================
    
    // Start screen state
    let isGameStarted = false;
    
    // Make isGameStarted globally available
    window.isGameStarted = isGameStarted;
    
    // Maze and game variables, going to work on optimizing
    var mazeStructure, startRow = 2, startCol = 2, endRow = 46, endCol = 46; // Make global for library.js
    let time = 0;
    let interval = false, startTime, startMaze;
    let first = 0;
    
    // Canvas rendering system - smooth pixel-based movement system
    // FORCE RESET to 0 to prevent any persistence across reloads
    let playerX = 0, playerY = 0; // Player position in pixels - EXPLICITLY RESET TO 0

    // Get the selected level (default to 1 if not set)
    const selectedLevel = window.selectedLevel || 1;
    const mazeData = window.MazeRenderer.getMazeData(selectedLevel);
    console.log('DEBUG: Maze data for level', selectedLevel, ':', mazeData);
    const predefinedMaze = mazeData.mazeStructure;
    mazeStructure = predefinedMaze;

    // Size variables
    let mazeWidth = mazeData.mazeWidth, mazeHeight = mazeData.mazeHeight, cellSize;

    // Calculate cell size based only on screen dimensions (not maze size)
    cellSize = Math.floor(Math.min(window.innerWidth, window.innerHeight) / 48);
    if (cellSize < 3) cellSize = 3; // Ensure minimum cell size for playability

    // HTML element references
    const startScreen = document.getElementById('start-screen');
    const startGameBtn = document.getElementById('start-game-btn');
    const settingsGear = document.getElementById('settings-gear');
    const upgradesBtn = document.getElementById('upgrades-btn');
    const aboutCorner = document.getElementById('about-corner');
    // Apply dynamic styling
    const mazeContainer = document.getElementById("maze-container");
    const canvas = document.getElementById("maze-canvas");
    const ctx = canvas.getContext("2d");
    const playerCanvas = document.getElementById("player-canvas");
    const playerCtx = playerCanvas.getContext("2d");
    const timerElement = document.getElementById("timer");
    const endScreen = document.getElementById("end-screen");
    const restartButton = document.getElementById("restart-button");
    const backButton = document.getElementById("back-button");
    const endText = document.getElementById("end-content");
    const endContent = document.getElementById("end-time-taken");
    const personalbest = document.getElementById("personal-best");
    const newpersonalbest = document.getElementById("new-personal-best");
    const controlsHint = document.getElementById('controls-hint');

    // Make all variables global for module access
    window.mazeContainer = mazeContainer;
    window.timerElement = timerElement;
    window.endScreen = endScreen;
    window.restartButton = restartButton;
    window.backButton = backButton;
    window.endContent = endContent;
    window.endText = endText;
    window.personalbest = personalbest;
    window.newpersonalbest = newpersonalbest;
    window.canvas = canvas;
    window.ctx = ctx;
    window.playerCanvas = playerCanvas;
    window.playerCtx = playerCtx;
    window.controlsHint = controlsHint;
    window.mazeStructure = mazeStructure;
    window.startRow = startRow;
    window.startCol = startCol;
    window.endRow = endRow;
    window.endCol = endCol;
    window.mazeWidth = mazeWidth;
    window.mazeHeight = mazeHeight;
    window.cellSize = cellSize;
    window.playerX = playerX;
    window.playerY = playerY;
    window.time = time;
    window.interval = interval;
    window.startTime = startTime;
    window.first = first;
    
    // FORCE CLEAR all browser storage to prevent any data persistence between sessions
    try {
      sessionStorage.clear();
      // Don't clear localStorage as it contains best times
    } catch (e) {
      // Silently handle storage errors
    }

    // Setup canvas using CanvasRenderer module
    console.log('DEBUG: mazeWidth =', mazeWidth, 'mazeHeight =', mazeHeight, 'cellSize =', cellSize);
    if (window.CanvasRenderer && window.CanvasRenderer.setupCanvas) {
      const canvasResult = window.CanvasRenderer.setupCanvas({width: mazeWidth, height: mazeHeight}, cellSize);
      console.log('DEBUG: Canvas setup result:', canvasResult);
    }
    
    // Initialize player position using PlayerController
    if (window.PlayerController && window.PlayerController.initializePlayerPosition) {
      window.PlayerController.initializePlayerPosition();
    } else {
      // Fallback position initialization
      window.playerX = startCol * cellSize;
      window.playerY = startRow * cellSize;
    }
    
    // Create virtual player using PlayerController
    if (window.PlayerController && window.PlayerController.createVirtualPlayer) {
      window.PlayerController.createVirtualPlayer();
    } else {
      console.warn('PlayerController not available for virtual player creation');
    }

    // Setup event handling through EventHandler module
    if (window.EventHandler) {
      window.EventHandler.setupEventListeners();
    } else {
      console.warn('EventHandler module not available - event handling may not work');
    }
    
    // Event listeners setup moved to GameInitializer module
    if (window.GameInitializer) {
      window.GameInitializer.setupEventListeners();
    } else {
      console.warn('GameInitializer module not loaded for event listeners');
    }
  </script>
</body>
</html>